<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workshop Blockchain - Live Dashboard</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 25%, #16213e 50%, #0f3460 75%, #000000 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }
        
        .dashboard-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            grid-template-rows: auto 1fr auto;
            grid-template-areas: 
                "header header"
                "main sidebar"
                "footer footer";
            min-height: 100vh;
            gap: 20px;
            padding: 20px;
        }
        
        .header {
            grid-area: header;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }
        
        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ffffff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
        }
        
        .workshop-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 1em;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .main-content {
            grid-area: main;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .mempool-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            flex: 1;
        }
        
        .section-title {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .mempool-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            height: 100%;
        }
        
        .mempool-list {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .mempool-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .mempool-item.new-item {
            border-color: #4CAF50;
            animation: pulse 2s ease-in-out;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }
        
        .tx-details {
            flex: 1;
        }
        
        .tx-hash {
            font-family: monospace;
            font-size: 0.8em;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        .tx-fee {
            background: rgba(255, 152, 0, 0.2);
            color: #FF9800;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .merkle-tree {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .tree-container {
            width: 100%;
            text-align: center;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .tree-level {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: center;
        }
        
        .tree-node {
            background: rgba(102, 126, 234, 0.2);
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 10px;
            min-width: 100px;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .tree-node.root {
            background: rgba(76, 175, 80, 0.2);
            border-color: #4CAF50;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .tree-node.leaf {
            background: rgba(255, 152, 0, 0.2);
            border-color: #FF9800;
            color: #FF9800;
            font-size: 0.8em;
        }
        
        .tree-connections {
            position: relative;
            height: 20px;
        }
        
        .tree-line {
            position: absolute;
            border-top: 2px solid rgba(255, 255, 255, 0.3);
            top: 50%;
        }
        
        .sidebar {
            grid-area: sidebar;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .participants-section, .mining-section, .blockchain-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .participant-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .participant-role {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .role-user {
            background: rgba(33, 150, 243, 0.2);
            color: #2196F3;
        }
        
        .role-miner {
            background: rgba(255, 152, 0, 0.2);
            color: #FF9800;
        }
        
        .mining-status {
            text-align: center;
            padding: 20px;
        }
        
        .mining-active {
            color: #4CAF50;
            font-size: 1.2em;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        
        .mining-waiting {
            color: #FF9800;
            opacity: 0.8;
        }
        
        .block-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .block-item.latest {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
            animation: pulse 2s ease-in-out;
        }
        
        .block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .block-number {
            font-size: 1.2em;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .block-hash {
            font-family: monospace;
            font-size: 0.7em;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        .footer {
            grid-area: footer;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }
        
        .footer-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .footer-stat {
            text-align: center;
        }
        
        .footer-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .footer-label {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background: #4CAF50;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.6);
        }
        
        .status-mining {
            background: #FF9800;
            box-shadow: 0 0 8px rgba(255, 152, 0, 0.6);
            animation: pulse 1.5s infinite;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            opacity: 0.6;
            font-style: italic;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1.1em;
            opacity: 0.8;
        }
        
        @media (max-width: 1200px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                grid-template-areas: 
                    "header"
                    "main"
                    "sidebar"
                    "footer";
            }
            
            .workshop-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .mempool-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>üåê Workshop Blockchain Network</h1>
            <p>Live Multiplayer Blockchain Simulator</p>
            
            <div class="workshop-stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalParticipants">0</div>
                    <div class="stat-label">Participants</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalBlocks">0</div>
                    <div class="stat-label">Blocks Mined</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalTransactions">0</div>
                    <div class="stat-label">Total Transactions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pendingTxs">0</div>
                    <div class="stat-label">Pending Txs</div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="mempool-section">
                <h2 class="section-title">üíæ Live Mempool & Merkle Tree</h2>
                
                <div class="mempool-grid">
                    <div class="mempool-list">
                        <h3 style="margin-bottom: 15px;">üìã Pending Transactions</h3>
                        <div id="mempoolList">
                            <div class="empty-state">
                                <p>No pending transactions...</p>
                                <small>Waiting for users to send transactions</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="merkle-tree">
                        <h3 style="margin-bottom: 15px;">üå≥ Merkle Tree</h3>
                        <div id="merkleTreeContainer">
                            <div class="empty-state">
                                <p>Tree will appear when transactions are pending</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="participants-section">
                <h2 class="section-title">üë• Participants</h2>
                <div id="participantsList" class="loading">
                    Waiting for participants to join...
                </div>
            </div>
            
            <div class="mining-section">
                <h2 class="section-title">‚õèÔ∏è Mining Status</h2>
                <div id="miningStatus" class="mining-status">
                    <div class="mining-waiting">Waiting for transactions...</div>
                </div>
            </div>
            
            <div class="blockchain-section">
                <h2 class="section-title">‚õìÔ∏è Latest Blocks</h2>
                <div id="blockchainList">
                    <div class="block-item">
                        <div class="block-header">
                            <div class="block-number">Genesis Block</div>
                        </div>
                        <div>Initial blockchain state</div>
                        <div class="block-hash">Hash: genesis_block_hash_000...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <div class="footer-stats">
                <div class="footer-stat">
                    <div class="footer-value" id="networkUptime">0:00</div>
                    <div class="footer-label">Network Uptime</div>
                </div>
                <div class="footer-stat">
                    <div class="footer-value" id="avgBlockTime">-</div>
                    <div class="footer-label">Avg Block Time</div>
                </div>
                <div class="footer-stat">
                    <div class="footer-value" id="totalFees">0.000</div>
                    <div class="footer-label">Total Fees Paid</div>
                </div>
                <div class="footer-stat">
                    <div class="footer-value" id="networkTps">0.00</div>
                    <div class="footer-label">Transactions/min</div>
                </div>
            </div>
            <p style="opacity: 0.7;">üöÄ Workshop Blockchain - Built with Love for Learning</p>
        </div>
    </div>

    <script>
        let socket = null;
        let participants = [];
        let mempool = [];
        let blockchain = [];
        let stats = {};
        let startTime = Date.now();
        let totalTransactionCount = 0;
        
        // Initialize socket
        socket = io();
        
        // Socket event handlers
        socket.on('connect', function() {
            console.log('üîå Dashboard connected to workshop server');
            updateConnectionStatus(true);
        });
        
        socket.on('disconnect', function() {
            console.log('üíî Dashboard disconnected');
            updateConnectionStatus(false);
        });
        
        socket.on('participant-joined', function(data) {
            participants = data.participants;
            stats = data.stats;
            updateParticipantsList();
            updateWorkshopStats();
            showNotification(`${data.participant.nickname} joined as ${data.participant.role}!`, 'success');
        });
        
        socket.on('participant-left', function(data) {
            participants = data.participants;
            stats = data.stats;
            updateParticipantsList();
            updateWorkshopStats();
            showNotification(`${data.participant.nickname} left the workshop`, 'info');
        });
        
        socket.on('new-transaction', function(data) {
            mempool = data.mempool;
            stats = data.stats;
            totalTransactionCount++;
            
            updateMempoolDisplay();
            updateMerkleTree();
            updateWorkshopStats();
            
            const tx = data.transaction;
            showNotification(`üí∏ ${tx.from} ‚Üí ${tx.to}: ${tx.amount} tokens`, 'transaction');
        });
        
        socket.on('miner-selected', function(data) {
            updateMiningStatus(`üéØ ${data.miner} selected to mine Block #${data.blockNumber}!`, 'active');
            showNotification(`‚õèÔ∏è ${data.miner} is mining Block #${data.blockNumber}`, 'mining');
        });
        
        socket.on('block-mined', function(data) {
            blockchain = data.blockchain;
            mempool = data.mempool;
            stats = data.stats;
            participants = data.participants;
            
            updateBlockchainDisplay();
            updateMempoolDisplay();
            updateMerkleTree();
            updateWorkshopStats();
            updateMiningStatus('‚è≥ Waiting for transactions...', 'waiting');
            
            const block = data.block;
            showNotification(`üéâ Block #${block.number} mined by ${block.miner}!`, 'success');
        });
        
        // Update functions
        function updateParticipantsList() {
            const container = document.getElementById('participantsList');
            
            if (participants.length === 0) {
                container.innerHTML = '<div class="loading">Waiting for participants to join...</div>';
                return;
            }
            
            const onlineParticipants = participants.filter(p => p.online);
            
            container.innerHTML = onlineParticipants.map(p => `
                <div class="participant-item">
                    <div>
                        <span class="status-indicator status-online"></span>
                        <strong>${p.nickname}</strong>
                        <br>
                        <small>${p.role === 'user' ? `${p.balance.toFixed(2)} tokens` : `${p.blocksMined || 0} blocks mined`}</small>
                    </div>
                    <div class="participant-role role-${p.role}">${p.role.toUpperCase()}</div>
                </div>
            `).join('');
        }
        
        function updateMempoolDisplay() {
            const container = document.getElementById('mempoolList');
            
            if (mempool.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No pending transactions...</p>
                        <small>Waiting for users to send transactions</small>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = mempool.map((tx, index) => `
                <div class="mempool-item ${index === mempool.length - 1 ? 'new-item' : ''}">
                    <div class="tx-details">
                        <strong>${tx.from} ‚Üí ${tx.to}</strong><br>
                        <small>${tx.amount} tokens</small>
                        <div class="tx-hash">${tx.hash.substring(0, 16)}...</div>
                    </div>
                    <div class="tx-fee">${tx.fee}</div>
                </div>
            `).join('');
        }
        
        function updateMerkleTree() {
            const container = document.getElementById('merkleTreeContainer');
            
            if (mempool.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>Tree will appear when transactions are pending</p>
                    </div>
                `;
                return;
            }
            
            // Build merkle tree visualization
            const txsToShow = mempool.slice(0, 4); // Max 4 for clean visualization
            const tree = buildMerkleTreeVisualization(txsToShow);
            
            container.innerHTML = `
                <div class="tree-container">
                    ${tree}
                </div>
            `;
        }
        
        function buildMerkleTreeVisualization(transactions) {
            if (transactions.length === 0) return '';
            
            const hashes = transactions.map(tx => tx.hash);
            
            // Simple binary tree structure
            const leaves = transactions.map((tx, i) => 
                `<div class="tree-node leaf">${tx.from}‚Üí${tx.to}<br><small>${tx.hash.substring(0, 8)}</small></div>`
            ).join('');
            
            // Calculate intermediate nodes (simplified)
            let currentLevel = hashes;
            const levels = [leaves];
            
            while (currentLevel.length > 1) {
                const nextLevel = [];
                const nodeHtml = [];
                
                for (let i = 0; i < currentLevel.length; i += 2) {
                    const left = currentLevel[i];
                    const right = currentLevel[i + 1] || left;
                    const combined = hashCombine(left, right);
                    nextLevel.push(combined);
                    nodeHtml.push(`<div class="tree-node">${combined.substring(0, 8)}...</div>`);
                }
                
                levels.unshift(nodeHtml.join(''));
                currentLevel = nextLevel;
            }
            
            // Root node
            if (currentLevel.length === 1) {
                levels.unshift(`<div class="tree-node root">Root<br><small>${currentLevel[0].substring(0, 8)}...</small></div>`);
            }
            
            return levels.map(level => `<div class="tree-level">${level}</div>`).join('<div class="tree-connections"></div>');
        }
        
        function hashCombine(a, b) {
            // Simple hash combination for visualization
            return (a + b).split('').reduce((hash, char) => {
                hash = ((hash << 5) - hash) + char.charCodeAt(0);
                return hash & hash;
            }, 0).toString(16).padStart(8, '0');
        }
        
        function updateBlockchainDisplay() {
            const container = document.getElementById('blockchainList');
            const recentBlocks = blockchain.slice(-5).reverse(); // Show last 5 blocks
            
            container.innerHTML = recentBlocks.map((block, index) => `
                <div class="block-item ${index === 0 ? 'latest' : ''}">
                    <div class="block-header">
                        <div class="block-number">Block #${block.number}</div>
                        <small>${new Date(block.timestamp).toLocaleTimeString()}</small>
                    </div>
                    <div>
                        <strong>Miner:</strong> ${block.miner}<br>
                        <strong>Transactions:</strong> ${block.transactions.length}
                    </div>
                    <div class="block-hash">Hash: ${block.hash.substring(0, 24)}...</div>
                </div>
            `).join('');
        }
        
        function updateMiningStatus(message, type) {
            const container = document.getElementById('miningStatus');
            const className = type === 'active' ? 'mining-active' : 'mining-waiting';
            container.innerHTML = `<div class="${className}">${message}</div>`;
        }
        
        function updateWorkshopStats() {
            const activeParticipants = participants.filter(p => p.online).length;
            
            document.getElementById('totalParticipants').textContent = activeParticipants;
            document.getElementById('totalBlocks').textContent = blockchain.length;
            document.getElementById('totalTransactions').textContent = stats.totalTransactions || totalTransactionCount;
            document.getElementById('pendingTxs').textContent = mempool.length;
            
            // Calculate additional stats
            updateNetworkStats();
        }
        
        function updateNetworkStats() {
            const now = Date.now();
            const uptimeMinutes = Math.floor((now - startTime) / 60000);
            const uptimeHours = Math.floor(uptimeMinutes / 60);
            const remainingMinutes = uptimeMinutes % 60;
            
            document.getElementById('networkUptime').textContent = 
                `${uptimeHours}:${remainingMinutes.toString().padStart(2, '0')}`;
            
            // Calculate average block time
            if (blockchain.length > 1) {
                const totalTime = blockchain[blockchain.length - 1].timestamp - blockchain[1].timestamp;
                const avgTime = Math.round(totalTime / (blockchain.length - 1) / 1000);
                document.getElementById('avgBlockTime').textContent = `${avgTime}s`;
            }
            
            // Calculate total fees
            const totalFees = blockchain.reduce((sum, block) => {
                return sum + block.transactions.reduce((blockSum, tx) => blockSum + tx.fee, 0);
            }, 0);
            document.getElementById('totalFees').textContent = totalFees.toFixed(3);
            
            // Calculate transactions per minute
            if (uptimeMinutes > 0) {
                const tps = (stats.totalTransactions || totalTransactionCount) / uptimeMinutes;
                document.getElementById('networkTps').textContent = tps.toFixed(2);
            }
        }
        
        function updateConnectionStatus(connected) {
            const headerTitle = document.querySelector('.header h1');
            if (connected) {
                headerTitle.style.color = '';
            } else {
                headerTitle.style.color = '#ff4444';
            }
        }
        
        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                border-left: 4px solid ${getNotificationColor(type)};
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
                max-width: 400px;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 4 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }
        
        function getNotificationColor(type) {
            switch (type) {
                case 'success': return '#4CAF50';
                case 'transaction': return '#2196F3';
                case 'mining': return '#FF9800';
                case 'info': return '#607D8B';
                default: return '#ffffff';
            }
        }
        
        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // Update network stats every 10 seconds
        setInterval(updateNetworkStats, 10000);
        
        // Initial load message
        console.log('üéØ Workshop Dashboard initialized');
        console.log('üëÄ Waiting for participants to join...');
    </script>
</body>
</html>